<script type="text/javascript">

    if (location.search != "") {
        console.log("DETECTED SOME URL PARAMS");
        var requestedTech = location.search.split("?tech=")[1];
        var requestedCat = location.search.split("?cat=")[1];
        var validTech = !(typeof(requestedTech) == "undefined");
        var validCat = !(typeof(requestedCat) == "undefined");
        var validRequest = (validTech || validCat) && !(validTech && validCat); // api only accepts either param, not both

        if (validRequest == true) {
            console.log("API REQUEST IS VALID");

            // FILTER POSTS

            var allPostsLinkTagStr = "<a href='/blog'>all posts</a>";

            if (validTech == true) {
                var selectedTech = requestedTech.trim().toLowerCase();
                console.log("SELECTED TECH:", selectedTech);
                var $selectedPosts = $( "div.post[data-technologies*='"+selectedTech+"']" );
                var $unselectedPosts = $( "div.post:not([data-technologies*='"+selectedTech+"'])" );
                var suggestedTechLinkTagStr = "<a href='/blog?tech=ruby'>'ruby'</a>";
                var errorMessageContent = "Sorry, found no posts matching the selected technology, '" + selectedTech + "'. Why don't you try " + suggestedTechLinkTagStr + " instead? Or "+allPostsLinkTagStr+"..."
                var successMessageContent = "Found " + $selectedPosts.length + " posts matching the selected technology, '" + selectedTech + "'."
            } else if (validCat == true) {
                var selectedCat = requestedCat.trim().toLowerCase();
                console.log("SELECTED CATEGORY:", selectedCat);
                var $selectedPosts = $( "div.post[data-categories*='"+selectedCat+"']" );
                var $unselectedPosts = $( "div.post:not([data-categories*='"+selectedCat+"'])" );
                var suggestedCatLinkTagStr = "<a href='/blog?cat=data-visualization'>'data-visualization'</a>";
                var errorMessageContent = "Sorry, found no posts matching the selected category, '" + selectedCat + "'. Why don't you try " + suggestedCatLinkTagStr + " instead? Or "+allPostsLinkTagStr+"..."
                var successMessageContent = "Found " + $selectedPosts.length + " posts matching the selected category, '" + selectedCat + "'."
            };
            console.log("SELECTED:", $selectedPosts.length, "UNSELECTED:", $unselectedPosts.length);

            // UPDATE RESPONSE MESSAGE

            var responseMessage = d3.select("span#api-response-message").append("p")
                .classed("text-center",1)
                .style("margin-bottom", "2em");

            if ( $selectedPosts.length == 0 ) {
                console.log("OOPS, NO MATCHING POSTS");
                responseMessage.html(errorMessageContent);
            } else {
                responseMessage.html(successMessageContent);
            };

            // KEEP SELECTED POSTS ONLY

            $unselectedPosts.each(function(i, el){
                el.remove();
            });

            // RE-STYLE REMAINING POSTS (see /_includes/post_list for initial styles)

            var liClassListA = "col-lg-5 col-sm-6";
            var imgClassListA = liClassListA+" col-lg-offset-2";

            var classListB = "col-lg-5 col-sm-6";
            var liClassListB = classListB+" col-lg-offset-1 col-sm-push-6";
            var imgClassListB = classListB+" col-sm-pull-6";

            $selectedPosts.each(function(i, el){
                console.log(el.classList);
                $(this).removeClass("content-section-a content-section-b"); // clear both striping classes

                if (i % 2) {
                    console.log("B",i)
                    $(this).addClass("content-section-b");
                    $(this).find(".post_list_item")
                        .removeClass()
                        .addClass(liClassListB);
                    $(this).find(".post_list_image")
                        .removeClass()
                        .addClass(imgClassListB);
                } else {
                    console.log("A",i)
                    $(this).addClass("content-section-a");
                    $(this).find(".post_list_item")
                        .removeClass()
                        .addClass(liClassListA);
                    $(this).find(".post_list_image")
                        .removeClass()
                        .addClass(imgClassListA);
                };
            });

        }; // if there is a valid api request

    }; // if url params are present

</script>
